<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Changelog - Proyectos Shopify</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-bg: #fafafa; --color-surface: #ffffff; --color-text: #1a1a1a;
            --color-text-secondary: #6b7280; --color-border: #e5e7eb; --color-border-light: #f3f4f6;
            --status-completed: #16a34a; --status-completed-bg: #dcfce7;
            --status-in-progress: #2563eb; --status-in-progress-bg: #dbeafe;
            --status-todo: #6b7280; --status-todo-bg: #f3f4f6;
            --status-blocked: #dc2626; --status-blocked-bg: #fee2e2;
            --status-qa: #7c3aed; --status-qa-bg: #ede9fe;
            --status-cancelled: #78716c; --status-cancelled-bg: #f5f5f4;
            --status-approval: #f59e0b; --status-approval-bg: #fef3c7;
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', monospace; --radius: 8px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-sans); background: var(--color-bg); color: var(--color-text); line-height: 1.6; }
        .header { background: var(--color-surface); border-bottom: 1px solid var(--color-border); padding: 24px 0; position: sticky; top: 0; z-index: 100; }
        .header-content { max-width: 1000px; margin: 0 auto; padding: 0 24px; }
        .header h1 { font-size: 28px; font-weight: 700; margin-bottom: 4px; }
        .header p { color: var(--color-text-secondary); font-size: 15px; }
        .filters { background: var(--color-surface); border-bottom: 1px solid var(--color-border); padding: 16px 0; }
        .filters-content { max-width: 1000px; margin: 0 auto; padding: 0 24px; display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
        .filter-btn { padding: 8px 16px; border: 1px solid var(--color-border); background: var(--color-surface); border-radius: 20px; font-size: 14px; font-weight: 500; color: var(--color-text-secondary); cursor: pointer; transition: all 0.2s ease; font-family: var(--font-sans); }
        .filter-btn:hover { border-color: var(--color-text); color: var(--color-text); }
        .filter-btn.active { background: var(--color-text); color: white; border-color: var(--color-text); }
        .filter-label { font-size: 13px; color: var(--color-text-secondary); font-weight: 500; }
        .main { max-width: 1000px; margin: 0 auto; padding: 32px 24px; }
        .summary-section { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius); padding: 24px; margin-bottom: 24px; }
        .summary-stats { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .stat-card { display: flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; border: 2px solid transparent; }
        .stat-card:hover { transform: scale(1.02); opacity: 0.9; }
        .stat-card.active { border-color: var(--color-text); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        .stat-card .stat-count { font-weight: 700; font-size: 16px; }
        .stat-completed { background: var(--status-completed-bg); color: var(--status-completed); }
        .stat-in-progress { background: var(--status-in-progress-bg); color: var(--status-in-progress); }
        .stat-blocked { background: var(--status-blocked-bg); color: var(--status-blocked); }
        .stat-todo { background: var(--status-todo-bg); color: var(--status-todo); }
        .stat-qa { background: var(--status-qa-bg); color: var(--status-qa); }
        .stat-cancelled { background: var(--status-cancelled-bg); color: var(--status-cancelled); }
        .summary-text { font-size: 14px; line-height: 1.7; color: var(--color-text); background: var(--color-border-light); padding: 16px; border-radius: var(--radius); margin-bottom: 16px; white-space: pre-line; }
        .secondary-filters { background: var(--color-border-light); border-radius: var(--radius); padding: 16px; margin-bottom: 24px; }
        .filter-row { display: flex; gap: 24px; flex-wrap: wrap; align-items: flex-start; }
        .filter-group { flex: 1; min-width: 200px; max-width: 100%; }
        .filter-group-title { font-size: 11px; font-weight: 600; color: var(--color-text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .filter-group-title span { background: var(--color-text-secondary); color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; }
        .filter-tags { display: flex; gap: 6px; flex-wrap: wrap; max-height: 150px; overflow-y: auto; padding: 4px 0; }
        .filter-tag { padding: 4px 10px; border-radius: 14px; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; background: var(--color-surface); border: 1px solid var(--color-border); color: var(--color-text-secondary); white-space: nowrap; }
        .filter-tag:hover { border-color: var(--color-text); color: var(--color-text); }
        .filter-tag.active { background: var(--status-in-progress); color: white; border-color: var(--status-in-progress); }
        .clear-filters { font-size: 12px; color: var(--status-blocked); cursor: pointer; padding: 4px 10px; background: var(--status-blocked-bg); border-radius: 14px; white-space: nowrap; align-self: flex-start; margin-top: 20px; }
        .clear-filters:hover { opacity: 0.8; }
        .blockers-section { background: var(--status-blocked-bg); border: 1px solid #fecaca; border-radius: var(--radius); padding: 16px; margin-top: 16px; }
        .blockers-title { font-size: 14px; font-weight: 600; color: var(--status-blocked); margin-bottom: 12px; }
        .blocker-item { display: flex; justify-content: space-between; align-items: flex-start; padding: 10px 0; border-bottom: 1px solid #fecaca; gap: 12px; }
        .blocker-item:last-child { border-bottom: none; padding-bottom: 0; }
        .blocker-info { flex: 1; }
        .blocker-title { font-size: 14px; font-weight: 500; color: var(--color-text); text-decoration: none; }
        .blocker-title:hover { color: var(--status-in-progress); }
        .blocker-meta { font-size: 12px; color: var(--color-text-secondary); margin-top: 4px; }
        .blocker-deadline { font-size: 12px; font-weight: 600; color: var(--status-blocked); white-space: nowrap; }
        .changelog-entry { display: grid; grid-template-columns: 90px 1fr; gap: 20px; padding: 20px 0; border-bottom: 1px solid var(--color-border-light); }
        .entry-date { font-size: 13px; color: var(--color-text-secondary); font-weight: 500; }
        .entry-content { display: flex; flex-direction: column; gap: 6px; }
        .entry-title { font-size: 15px; font-weight: 600; color: var(--color-text); text-decoration: none; }
        .entry-title:hover { color: var(--status-in-progress); }
        .entry-description { font-size: 13px; color: var(--color-text-secondary); line-height: 1.5; }
        .entry-badges { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 4px; }
        .badge { display: inline-flex; padding: 3px 8px; border-radius: 10px; font-size: 11px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.3px; }
        .badge-project { background: var(--color-border-light); color: var(--color-text-secondary); }
        .badge-epic { background: #e0e7ff; color: #4338ca; }
        .status-completada { background: var(--status-completed-bg); color: var(--status-completed); }
        .status-en-progreso { background: var(--status-in-progress-bg); color: var(--status-in-progress); }
        .status-por-hacer, .status-estimacion, .status-standby { background: var(--status-todo-bg); color: var(--status-todo); }
        .status-pte-requisitos, .status-rechazada { background: var(--status-blocked-bg); color: var(--status-blocked); }
        .status-qa { background: var(--status-qa-bg); color: var(--status-qa); }
        .status-cancelada { background: var(--status-cancelled-bg); color: var(--status-cancelled); }
        .status-pte-aprobacion { background: var(--status-approval-bg); color: var(--status-approval); }
        .entry-meta { display: flex; gap: 12px; font-size: 12px; color: var(--color-text-secondary); flex-wrap: wrap; }
        .deadline-overdue { color: var(--status-blocked); font-weight: 600; }
        .deadline-soon { color: var(--status-approval); }
        .issue-key { font-family: var(--font-mono); font-size: 11px; color: var(--status-in-progress); text-decoration: none; font-weight: 500; }
        .issue-key:hover { text-decoration: underline; }
        .entry-comments { font-size: 13px; color: var(--color-text); padding: 10px 14px; background: var(--color-border-light); border-radius: var(--radius); margin-top: 6px; border-left: 3px solid var(--status-in-progress); }
        .loading { text-align: center; padding: 60px 40px; color: var(--color-text-secondary); }
        .loading-spinner { width: 48px; height: 48px; border: 4px solid var(--color-border); border-top-color: var(--status-in-progress); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 24px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .progress-bar { width: 100%; max-width: 400px; height: 12px; background: var(--color-border); border-radius: 6px; margin: 20px auto; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--status-in-progress), var(--status-completed)); transition: width 0.3s ease; }
        .error { background: var(--status-blocked-bg); color: var(--status-blocked); padding: 24px; border-radius: var(--radius); text-align: center; margin: 40px auto; max-width: 500px; }
        .total-count { text-align: center; padding: 16px; color: var(--color-text-secondary); font-size: 14px; background: var(--color-surface); border-radius: var(--radius); margin-bottom: 16px; }
        .total-count strong { color: var(--color-text); }
        .empty-state { text-align: center; padding: 60px; color: var(--color-text-secondary); }
        .no-results { text-align: center; padding: 40px; color: var(--color-text-secondary); background: var(--color-border-light); border-radius: var(--radius); margin: 20px 0; }
        .pagination { display: flex; justify-content: center; align-items: center; gap: 16px; padding: 24px; flex-wrap: wrap; }
        .pagination button { padding: 10px 20px; border: 1px solid var(--color-border); background: var(--color-surface); border-radius: 6px; cursor: pointer; font-size: 14px; }
        .pagination button:hover:not(:disabled) { border-color: var(--color-text); }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination span { color: var(--color-text-secondary); font-size: 14px; }
        @media (max-width: 640px) {
            .changelog-entry { grid-template-columns: 1fr; gap: 8px; }
            .filters-content { gap: 8px; }
            .filter-btn { padding: 6px 12px; font-size: 13px; }
            .filter-row { flex-direction: column; gap: 16px; }
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <script>
        // =====================================================================
        // ‚öôÔ∏è CONFIGURACI√ìN - EDITA AQU√ç TUS CREDENCIALES DE JIRA
        // =====================================================================
        const CONFIG = {
            // Tu email de Atlassian/Jira
            EMAIL: 'anabel.osuna@educaedtech.com',
            
            // Tu API Token de Jira (cr√©alo en: https://id.atlassian.com/manage-profile/security/api-tokens)
            TOKEN: 'ATATT3xFfGF0Ub1lfVMcQduiEKQeMEn58LdEJuFRN-3SwId-lCpYwdrGcAC2DYEJ8nizO7_fZWpgfseUH9zDcYjVcmeKJlgGRcADPX2ha7kWUHiVK6iGEPqr3_RCY0Ute25oiPljJ5DbQpcaUWBNfZshi1MlUefy7eRZt2STsFZnuk5PjQxL5Mc=4DDA4704',
            
            // URL base de tu instancia de Jira
            JIRA_URL: 'https://educaedtech.atlassian.net'
        };
        // =====================================================================
        
        const PROJECTS = [
            { key: 'SEI', name: 'Euroinnova' },
            { key: 'SEH', name: 'EducaHub' },
            { key: 'SUM', name: 'Unimiami' },
            { key: 'SST', name: 'Structuralia' },
            { key: 'STP', name: 'Temarioenpdf' },
            { key: 'SFC', name: 'Formaci√≥n Continua' },
            { key: 'SCL', name: 'Centro de Lengua Capman' },
            { key: 'SED', name: 'Entorno Desarrollo' },
            { key: 'EHC', name: 'EduHub Core' }
        ];
        
        const CORS_PROXY = 'https://jira-proxy.shopify-48b.workers.dev/?url=';
        const BLOCKER_STATUSES = ['PTE REQUISITOS'];
        const ESTADOS_IGNORAR_VENCIMIENTO = ['COMPLETADA', 'CANCELADA', 'STANDBY', 'PTE REQUISITOS'];
        const PAGE_SIZE = 100;
        const DISPLAY_PAGE_SIZE = 50;
        
        const COMMENT_FILTERS = [
            'this work item', 'created based on', 'jira form', 'email address:',
            'automation for jira', 'automatically', '[automation]', 'transitioned'
        ];
        
        let state = {
            allIssues: [], filteredIssues: [],
            loading: false, loadingProgress: 0, loadingTotal: 0,
            error: null, selectedProject: 'ALL',
            filterStatus: null, filterEpic: null, filterUser: null,
            epics: [], users: [], currentPage: 0
        };
        
        function formatDate(dateString) {
            if (!dateString) return '';
            return new Date(dateString).toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' });
        }
        
        function truncate(text, maxLength = 140) {
            if (!text) return '';
            const clean = String(text).replace(/<[^>]*>/g, '').replace(/\{[^}]*\}/g, '').replace(/\s+/g, ' ').trim();
            return clean.length <= maxLength ? clean : clean.substring(0, maxLength).trim() + '...';
        }
        
        function extractTextFromADF(adfContent) {
            if (!adfContent) return '';
            if (typeof adfContent === 'string') return adfContent;
            if (typeof adfContent !== 'object') return String(adfContent);
            let text = '';
            function traverse(node) {
                if (!node) return;
                if (typeof node === 'string') { text += node + ' '; return; }
                if (node.text) text += node.text + ' ';
                if (node.content && Array.isArray(node.content)) node.content.forEach(traverse);
            }
            traverse(adfContent);
            return text.trim();
        }
        
        function isAutoComment(text) {
            if (!text) return true;
            const lower = text.toLowerCase();
            return COMMENT_FILTERS.some(f => lower.includes(f));
        }
        
        function getRelevantComment(comments) {
            if (!comments || !comments.length) return '';
            for (let i = comments.length - 1; i >= 0; i--) {
                const c = comments[i];
                if (!c?.body) continue;
                const text = extractTextFromADF(c.body);
                if (text && !isAutoComment(text) && text.length > 10) return truncate(text, 200);
            }
            return '';
        }
        
        function getStatusClass(status) {
            const map = {
                'COMPLETADA': 'completada', 'CANCELADA': 'cancelada', 'EN PROGRESO': 'en-progreso',
                'POR HACER': 'por-hacer', 'ESTIMACI√ìN': 'estimacion', 'ESTIMACION': 'estimacion',
                'PTE DE APROBACI√ìN': 'pte-aprobacion', 'PTE APROBACI√ìN PR': 'pte-aprobacion',
                'PTE REQUISITOS': 'pte-requisitos', 'STANDBY': 'standby', 'RECHAZADA - POR HACER': 'rechazada',
                'QA - ENTORNO DEV': 'qa', 'QA - ENTORNO PROD': 'qa', 'APROBADO QA DEV': 'qa'
            };
            return map[status?.toUpperCase()] || 'por-hacer';
        }
        
        function getStatusCategory(status) {
            const s = (status || '').toUpperCase();
            if (s === 'COMPLETADA') return 'completed';
            if (s === 'EN PROGRESO') return 'inProgress';
            if (s.includes('QA') || s.includes('APROBADO')) return 'qa';
            if (BLOCKER_STATUSES.includes(s)) return 'blocked';
            if (s === 'CANCELADA') return 'cancelled';
            return 'todo';
        }
        
        function getDueDateStatus(duedate, status) {
            if (!duedate) return { class: '', text: '' };
            const due = new Date(duedate);
            const today = new Date(); today.setHours(0,0,0,0);
            const diffDays = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
            const statusUpper = (status || '').toUpperCase();
            if (diffDays < 0 && !ESTADOS_IGNORAR_VENCIMIENTO.includes(statusUpper)) return { class: 'deadline-overdue', text: '‚ö†Ô∏è Vencida: ' };
            if (diffDays >= 0 && diffDays <= 3) return { class: 'deadline-soon', text: '‚è∞ ' };
            return { class: '', text: 'üìÖ ' };
        }
        
        function extractFiltersData() {
            const epicsMap = new Map();
            const usersMap = new Map();
            state.allIssues.forEach(issue => {
                const epic = issue.fields.parent?.fields?.summary;
                if (epic) epicsMap.set(epic, (epicsMap.get(epic) || 0) + 1);
                const user = issue.fields.assignee?.displayName;
                if (user) usersMap.set(user, (usersMap.get(user) || 0) + 1);
            });
            state.epics = Array.from(epicsMap.entries()).sort((a, b) => b[1] - a[1]).map(e => ({ name: e[0], count: e[1] }));
            state.users = Array.from(usersMap.entries()).sort((a, b) => b[1] - a[1]).map(u => ({ name: u[0], count: u[1] }));
        }
        
        function applyFilters() {
            let filtered = [...state.allIssues];
            if (state.filterStatus) filtered = filtered.filter(i => getStatusCategory(i.fields.status?.name) === state.filterStatus);
            if (state.filterEpic) filtered = filtered.filter(i => i.fields.parent?.fields?.summary === state.filterEpic);
            if (state.filterUser) filtered = filtered.filter(i => i.fields.assignee?.displayName === state.filterUser);
            state.filteredIssues = filtered;
            state.currentPage = 0;
        }
        
        function clearFilters() {
            state.filterStatus = null;
            state.filterEpic = null;
            state.filterUser = null;
            state.filteredIssues = [...state.allIssues];
            state.currentPage = 0;
        }
        
        async function fetchAllIssues() {
            state.loading = true;
            state.allIssues = [];
            state.filteredIssues = [];
            state.loadingProgress = 0;
            state.loadingTotal = 0;
            state.error = null;
            clearFilters();
            render();
            
            try {
                const projectFilter = state.selectedProject === 'ALL'
                    ? `project IN ("${PROJECTS.map(p => p.key).join('", "')}")`
                    : `project = "${state.selectedProject}"`;
                
                const jql = `${projectFilter} ORDER BY updated DESC`;
                let nextPageToken = null;
                let allIssues = [];
                
                do {
                    let apiUrl = `${CONFIG.JIRA_URL}/rest/api/3/search/jql?jql=${encodeURIComponent(jql)}&maxResults=${PAGE_SIZE}&fields=summary,description,status,created,updated,resolutiondate,assignee,comment,duedate,parent`;
                    if (nextPageToken) apiUrl += `&nextPageToken=${encodeURIComponent(nextPageToken)}`;
                    
                    const response = await fetch(CORS_PROXY + encodeURIComponent(apiUrl), {
                        method: 'GET',
                        headers: {
                            'Authorization': 'Basic ' + btoa(CONFIG.EMAIL + ':' + CONFIG.TOKEN),
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        if (response.status === 401) throw new Error('Credenciales inv√°lidas. Revisa EMAIL y TOKEN en el c√≥digo.');
                        if (response.status === 403) throw new Error('Sin permisos para acceder a Jira.');
                        throw new Error('Error ' + response.status);
                    }
                    
                    const data = await response.json();
                    allIssues = [...allIssues, ...(data.issues || [])];
                    
                    if (state.loadingTotal === 0 && data.total) state.loadingTotal = data.total;
                    state.loadingProgress = allIssues.length;
                    render();
                    
                    nextPageToken = data.nextPageToken;
                    if (nextPageToken) await new Promise(r => setTimeout(r, 50));
                } while (nextPageToken);
                
                state.allIssues = allIssues;
                state.filteredIssues = [...allIssues];
                extractFiltersData();
                
            } catch (err) {
                state.error = err.message;
            } finally {
                state.loading = false;
                render();
            }
        }
        
        function render() {
            const app = document.getElementById('app');
            app.innerHTML = renderMainApp();
            attachMainEvents();
        }
        
        function renderMainApp() {
            const stats = calculateStats();
            const blockers = state.filteredIssues.filter(i => BLOCKER_STATUSES.includes(i.fields.status?.name?.toUpperCase()));
            const hasFilters = state.filterStatus || state.filterEpic || state.filterUser;
            const startIdx = state.currentPage * DISPLAY_PAGE_SIZE;
            const endIdx = startIdx + DISPLAY_PAGE_SIZE;
            const displayIssues = state.filteredIssues.slice(startIdx, endIdx);
            const totalPages = Math.ceil(state.filteredIssues.length / DISPLAY_PAGE_SIZE);
            
            return `
                <header class="header"><div class="header-content"><h1>üîÑ Changelog</h1><p>Novedades y actualizaciones de los proyectos Shopify - EducaEdtech</p></div></header>
                <nav class="filters">
                    <div class="filters-content">
                        <span class="filter-label">Proyecto:</span>
                        <button class="filter-btn ${state.selectedProject === 'ALL' ? 'active' : ''}" data-project="ALL">Todos</button>
                        ${PROJECTS.map(p => `<button class="filter-btn ${state.selectedProject === p.key ? 'active' : ''}" data-project="${p.key}">${p.name}</button>`).join('')}
                    </div>
                </nav>
                <main class="main">
                    ${state.error ? `<div class="error">‚ö†Ô∏è ${state.error}</div>` : ''}
                    
                    ${state.loading ? `
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <p style="font-size:20px;font-weight:600;margin-bottom:8px;">Cargando historial completo...</p>
                            <p style="font-size:32px;font-weight:700;color:var(--status-in-progress);">${state.loadingProgress}${state.loadingTotal ? ` / ${state.loadingTotal}` : ''}</p>
                            <p style="margin-top:8px;font-size:14px;">tareas cargadas</p>
                            ${state.loadingTotal ? `<div class="progress-bar"><div class="progress-fill" style="width: ${Math.round(state.loadingProgress/state.loadingTotal*100)}%"></div></div>
                            <p style="font-size:13px;color:var(--color-text-secondary);">${Math.round(state.loadingProgress/state.loadingTotal*100)}% completado</p>` : ''}
                        </div>
                    ` : ''}
                    
                    ${!state.loading && !state.error && state.allIssues.length > 0 ? `
                        ${renderSummary(stats, blockers)}
                        ${renderSecondaryFilters(hasFilters)}
                        
                        <div class="total-count">
                            üìä <strong>${state.allIssues.length}</strong> tareas en el historial completo
                            ${hasFilters ? ` ‚Üí Mostrando <strong>${state.filteredIssues.length}</strong> con filtros aplicados` : ''}
                        </div>
                        
                        ${state.filteredIssues.length > 0 ? `
                            ${displayIssues.map(i => renderEntry(i)).join('')}
                            ${totalPages > 1 ? `
                                <div class="pagination">
                                    <button id="prevPage" ${state.currentPage === 0 ? 'disabled' : ''}>‚Üê Anterior</button>
                                    <span>P√°gina ${state.currentPage + 1} de ${totalPages}</span>
                                    <button id="nextPage" ${state.currentPage >= totalPages - 1 ? 'disabled' : ''}>Siguiente ‚Üí</button>
                                </div>
                            ` : ''}
                        ` : '<div class="no-results">No hay tareas con los filtros seleccionados</div>'}
                    ` : ''}
                    
                    ${!state.loading && !state.error && state.allIssues.length === 0 ? '<div class="empty-state"><p>No hay tareas</p></div>' : ''}
                </main>`;
        }
        
        function calculateStats() {
            const stats = { completed: 0, inProgress: 0, blocked: 0, todo: 0, qa: 0, cancelled: 0 };
            state.allIssues.forEach(i => { stats[getStatusCategory(i.fields.status?.name)]++; });
            return stats;
        }
        
        function generateDetailedSummary(stats) {
            const total = state.allIssues.length;
            if (total === 0) return '';
            
            const projectName = state.selectedProject === 'ALL' ? 'TODOS LOS PROYECTOS' : PROJECTS.find(p => p.key === state.selectedProject)?.name?.toUpperCase() || state.selectedProject;
            
            const overdue = state.allIssues.filter(i => {
                if (!i.fields.duedate) return false;
                const due = new Date(i.fields.duedate);
                const today = new Date(); today.setHours(0,0,0,0);
                return due < today && !ESTADOS_IGNORAR_VENCIMIENTO.includes((i.fields.status?.name || '').toUpperCase());
            }).length;
            
            const thisWeek = state.allIssues.filter(i => {
                if (!i.fields.updated) return false;
                const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate() - 7);
                return new Date(i.fields.updated) >= weekAgo;
            }).length;
            
            const recentlyCompleted = state.allIssues.filter(i => {
                if (i.fields.status?.name?.toUpperCase() !== 'COMPLETADA' || !i.fields.resolutiondate) return false;
                const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate() - 7);
                return new Date(i.fields.resolutiondate) >= weekAgo;
            }).length;
            
            let summary = `üìä RESUMEN DE ${projectName}\n\n`;
            summary += `Historial completo: ${total} tareas desde el inicio del proyecto.\n\n`;
            summary += `üìà ESTADO ACTUAL:\n`;
            if (stats.completed > 0) summary += `‚Ä¢ ‚úÖ ${stats.completed} completadas (${Math.round(stats.completed/total*100)}%)\n`;
            if (stats.inProgress > 0) summary += `‚Ä¢ üîÑ ${stats.inProgress} en progreso\n`;
            if (stats.qa > 0) summary += `‚Ä¢ üß™ ${stats.qa} en QA/testing\n`;
            if (stats.blocked > 0) summary += `‚Ä¢ üö´ ${stats.blocked} bloqueadas\n`;
            if (stats.todo > 0) summary += `‚Ä¢ ‚è≥ ${stats.todo} pendientes\n`;
            if (stats.cancelled > 0) summary += `‚Ä¢ ‚ùå ${stats.cancelled} canceladas\n`;
            
            if (recentlyCompleted > 0 || thisWeek > 0 || overdue > 0) {
                summary += `\nüìÖ √öLTIMA SEMANA:\n`;
                if (recentlyCompleted > 0) summary += `‚Ä¢ ${recentlyCompleted} tareas completadas\n`;
                if (thisWeek > 0) summary += `‚Ä¢ ${thisWeek} tareas actualizadas\n`;
                if (overdue > 0) summary += `‚Ä¢ ‚ö†Ô∏è ${overdue} con fecha vencida\n`;
            }
            
            if (state.users.length > 0) {
                summary += `\nüë• TOP COLABORADORES:\n`;
                state.users.slice(0, 5).forEach(u => { summary += `‚Ä¢ ${u.name}: ${u.count} tareas\n`; });
            }
            
            return truncate(summary, 2400);
        }
        
        function renderSummary(stats, blockers) {
            return `
                <div class="summary-section">
                    <div class="summary-stats">
                        <div class="stat-card stat-completed ${state.filterStatus === 'completed' ? 'active' : ''}" data-status="completed"><span class="stat-count">${stats.completed}</span><span>Completadas</span></div>
                        <div class="stat-card stat-in-progress ${state.filterStatus === 'inProgress' ? 'active' : ''}" data-status="inProgress"><span class="stat-count">${stats.inProgress}</span><span>En Progreso</span></div>
                        <div class="stat-card stat-qa ${state.filterStatus === 'qa' ? 'active' : ''}" data-status="qa"><span class="stat-count">${stats.qa}</span><span>En QA</span></div>
                        <div class="stat-card stat-blocked ${state.filterStatus === 'blocked' ? 'active' : ''}" data-status="blocked"><span class="stat-count">${stats.blocked}</span><span>Bloqueadas</span></div>
                        <div class="stat-card stat-todo ${state.filterStatus === 'todo' ? 'active' : ''}" data-status="todo"><span class="stat-count">${stats.todo}</span><span>Pendientes</span></div>
                        ${stats.cancelled > 0 ? `<div class="stat-card stat-cancelled ${state.filterStatus === 'cancelled' ? 'active' : ''}" data-status="cancelled"><span class="stat-count">${stats.cancelled}</span><span>Canceladas</span></div>` : ''}
                    </div>
                    <div class="summary-text">${generateDetailedSummary(stats)}</div>
                    ${blockers.length > 0 && !state.filterStatus ? `
                        <div class="blockers-section">
                            <div class="blockers-title">üö´ STOPPERS (${blockers.length})</div>
                            ${blockers.slice(0, 5).map(i => {
                                const p = PROJECTS.find(x => x.key === i.key.split('-')[0]);
                                const d = getDueDateStatus(i.fields.duedate, i.fields.status?.name);
                                return `<div class="blocker-item"><div class="blocker-info"><a href="${CONFIG.JIRA_URL}/browse/${i.key}" target="_blank" class="blocker-title">${i.fields.summary}</a><div class="blocker-meta">${i.key} ‚Ä¢ ${p?.name || ''} ‚Ä¢ ${i.fields.status?.name || ''}${i.fields.assignee ? ' ‚Ä¢ ' + i.fields.assignee.displayName : ''}</div></div>${i.fields.duedate ? `<span class="blocker-deadline ${d.class}">${d.text}${formatDate(i.fields.duedate)}</span>` : ''}</div>`;
                            }).join('')}
                        </div>
                    ` : ''}
                </div>`;
        }
        
        function renderSecondaryFilters(hasFilters) {
            return `
                <div class="secondary-filters">
                    <div class="filter-row">
                        <div class="filter-group">
                            <div class="filter-group-title">√âpicas <span>${state.epics.length}</span></div>
                            <div class="filter-tags">
                                ${state.epics.length > 0 ? state.epics.map(e => `<span class="filter-tag ${state.filterEpic === e.name ? 'active' : ''}" data-epic="${e.name}" title="${e.name}">${truncate(e.name, 25)} (${e.count})</span>`).join('') : '<span style="color:var(--color-text-secondary);font-size:12px;">Sin √©picas</span>'}
                            </div>
                        </div>
                        <div class="filter-group">
                            <div class="filter-group-title">Usuarios <span>${state.users.length}</span></div>
                            <div class="filter-tags">
                                ${state.users.length > 0 ? state.users.map(u => `<span class="filter-tag ${state.filterUser === u.name ? 'active' : ''}" data-user="${u.name}">${u.name.split(' ')[0]} (${u.count})</span>`).join('') : '<span style="color:var(--color-text-secondary);font-size:12px;">Sin usuarios</span>'}
                            </div>
                        </div>
                        ${hasFilters ? `<span class="clear-filters" id="clearFilters">‚úï Limpiar filtros</span>` : ''}
                    </div>
                </div>`;
        }
        
        function renderEntry(issue) {
            const status = issue.fields.status?.name || 'Sin estado';
            const project = PROJECTS.find(p => p.key === issue.key.split('-')[0]);
            const dueStatus = getDueDateStatus(issue.fields.duedate, status);
            const epic = issue.fields.parent?.fields?.summary;
            const description = issue.fields.description ? truncate(extractTextFromADF(issue.fields.description), 140) : '';
            const commentsSummary = getRelevantComment(issue.fields.comment?.comments || []);
            
            return `
                <div class="changelog-entry">
                    <div class="entry-date">${formatDate(issue.fields.created)}</div>
                    <div class="entry-content">
                        <a href="${CONFIG.JIRA_URL}/browse/${issue.key}" target="_blank" class="entry-title">${issue.fields.summary}</a>
                        ${description ? `<p class="entry-description">${description}</p>` : ''}
                        <div class="entry-badges">
                            <span class="badge status-${getStatusClass(status)}">${status}</span>
                            ${project ? `<span class="badge badge-project">${project.name}</span>` : ''}
                            ${epic ? `<span class="badge badge-epic">${truncate(epic, 20)}</span>` : ''}
                            <a href="${CONFIG.JIRA_URL}/browse/${issue.key}" target="_blank" class="issue-key">${issue.key}</a>
                        </div>
                        <div class="entry-meta">
                            ${issue.fields.resolutiondate ? `<span>‚úÖ ${formatDate(issue.fields.resolutiondate)}</span>` : ''}
                            ${issue.fields.duedate ? `<span class="${dueStatus.class}">${dueStatus.text}${formatDate(issue.fields.duedate)}</span>` : ''}
                            <span>üïê ${formatDate(issue.fields.updated)}</span>
                            <span>üë§ ${issue.fields.assignee?.displayName || 'Sin asignar'}</span>
                        </div>
                        ${commentsSummary ? `<div class="entry-comments">üí¨ ${commentsSummary}</div>` : ''}
                    </div>
                </div>`;
        }
        
        function attachMainEvents() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => { state.selectedProject = btn.dataset.project; fetchAllIssues(); });
            });
            document.querySelectorAll('.stat-card').forEach(card => {
                card.addEventListener('click', () => {
                    state.filterStatus = state.filterStatus === card.dataset.status ? null : card.dataset.status;
                    applyFilters(); render();
                });
            });
            document.querySelectorAll('[data-epic]').forEach(tag => {
                tag.addEventListener('click', () => {
                    state.filterEpic = state.filterEpic === tag.dataset.epic ? null : tag.dataset.epic;
                    applyFilters(); render();
                });
            });
            document.querySelectorAll('[data-user]').forEach(tag => {
                tag.addEventListener('click', () => {
                    state.filterUser = state.filterUser === tag.dataset.user ? null : tag.dataset.user;
                    applyFilters(); render();
                });
            });
            document.getElementById('clearFilters')?.addEventListener('click', () => { clearFilters(); render(); });
            document.getElementById('prevPage')?.addEventListener('click', () => { if (state.currentPage > 0) { state.currentPage--; render(); window.scrollTo(0, 0); } });
            document.getElementById('nextPage')?.addEventListener('click', () => {
                const totalPages = Math.ceil(state.filteredIssues.length / DISPLAY_PAGE_SIZE);
                if (state.currentPage < totalPages - 1) { state.currentPage++; render(); window.scrollTo(0, 0); }
            });
        }
        
        // Iniciar carga autom√°ticamente
        render();
        fetchAllIssues();
    </script>
</body>
</html>
